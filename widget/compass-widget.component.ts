/*
* Copyright (c) 2019 Software AG, Darmstadt, Germany and/or its licensors
*
* SPDX-License-Identifier: Apache-2.0
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
 */
import { Component, Input, OnDestroy, OnInit } from '@angular/core';
import { MeasurementService, Realtime } from '@c8y/client';
import { ICompassConfig } from "./i-compass-config";
import * as _ from 'lodash';

@Component({
    template:
        `
        <svg version="1.0" viewBox="0 0 470 470" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>
                <linearGradient id="a">
                    <stop stop-color="#414141" offset="0"/>
                    <stop stop-color="#f3f3f3" offset="1"/>
                </linearGradient>
                <filter id="i">
                    <feGaussianBlur stdDeviation="2.8141222"/>
                </filter>
                <filter id="h">
                    <feGaussianBlur stdDeviation="2.7531846"/>
                </filter>
                <filter id="g">
                    <feGaussianBlur stdDeviation="1.9888339"/>
                </filter>
                <radialGradient id="c" cx="-92.751" cy="69.905" r="91.071" gradientTransform="matrix(2.3805 .065952 -.030537 1.1022 212.45 -568.21)" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#020202" stop-opacity=".68085" offset="0"/>
                    <stop stop-color="#fff" stop-opacity="0" offset="1"/>
                </radialGradient>
                <linearGradient id="e" x1="164.3" x2="442" y1="172.87" y2="453.17" gradientUnits="userSpaceOnUse" xlink:href="#a"/>
                <linearGradient id="d" x1="415.65" x2="186.68" y1="446.43" y2="190.92" gradientUnits="userSpaceOnUse" xlink:href="#a"/>
                <radialGradient id="b" cx="-89.93" cy="85.675" r="91.071" gradientTransform="matrix(1.5357 .042548 -.0197 .71106 141.02 170.96)" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#fff" offset="0"/>
                    <stop stop-color="#fff" stop-opacity="0" offset="1"/>
                </radialGradient>
                <linearGradient id="f" x1="143.52" x2="247.19" y1="83.395" y2="267.86" gradientTransform="translate(-47.339,-48.103)" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#fff" offset="0"/>
                    <stop stop-color="#fff" stop-opacity="0" offset="1"/>
                </linearGradient>
            </defs>
            <g transform="translate(-25.585 -25.595)">
                <ellipse transform="matrix(-.70366 .71054 -.70368 -.71052 0 0)" cx="-3.3164" cy="-430.57" rx="216.88" ry="134.78" fill="url(#c)" fill-rule="evenodd" opacity=".6" stroke-width="2.1766"/>
                <path d="m417.33 253.9c0 89.79-72.88 162.66-162.67 162.66s-162.67-72.87-162.67-162.66c4e-3 -89.8 72.88-162.67 162.67-162.67s162.67 72.87 162.67 162.67z" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m254.66 91.23v11.29" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m254.66 404.17v11.29" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m296.62 96.754-2.92 10.906" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m215.62 399.03-2.92 10.91" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m335.72 112.95-5.65 9.78" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m179.25 383.96-5.65 9.78" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m369.29 138.71-7.98 7.99" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m148.01 359.99-7.98 7.99" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m395.06 172.29-9.78 5.64" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m124.04 328.76-9.77 5.64" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m411.25 211.39-10.9 2.92" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m108.98 292.38-10.91 2.92" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m416.78 253.35h-11.3" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m103.84 253.35h-11.294" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m411.25 295.3-10.9-2.92" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m108.98 214.31-10.91-2.92" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m395.06 334.4-9.78-5.64" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m124.04 177.93-9.77-5.64" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m369.29 367.98-7.98-7.99" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m148.01 146.7-7.98-7.99" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m335.72 393.74-5.65-9.78" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m179.25 122.73-5.65-9.78" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m296.62 409.94-2.92-10.91" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path d="m215.62 107.66-2.92-10.906" fill="none" opacity=".2" stroke="#000" stroke-width="1px"/>
                <path transform="matrix(1.1414,0,0,1.1498,-99.677,-110.66)" d="m310.72 133.94c-100.12 0-181.38 81.255-181.38 181.38 0 100.12 81.255 181.38 181.38 181.38 100.12 0 181.38-81.255 181.38-181.38 0-100.12-81.255-181.38-181.38-181.38z" fill="none" filter="url(#h)" stroke="#fff" stroke-width="5.2375"/>
                <path transform="matrix(1.154,0,0,1.1498,-105.91,-110.64)" d="m310.72 129.88c-102.31 0-185.43 83.115-185.43 185.43 0 102.31 83.115 185.43 185.43 185.43 102.31 0 185.43-83.115 185.43-185.43 0-102.31-83.115-185.43-185.43-185.43z" fill="none" filter="url(#i)" stroke="#000" stroke-width="4.3407"/>
                <path transform="matrix(1.154,0,0,1.1498,-105.91,-110.64)" d="m310.72 133.94c-100.12 0-181.38 81.255-181.38 181.38 0 100.12 81.255 181.38 181.38 181.38 100.12 0 181.38-81.255 181.38-181.38 0-100.12-81.255-181.38-181.38-181.38z" fill="none" stroke="url(#e)" stroke-width="4.3407"/>
                <path d="m245.29 116.45c-2.53 0.25-4.5 2.4-4.5 5v2.03c-14.9 1.36-29.07 5.25-42.07 11.25l-1-1.75c-1.38-2.4-4.47-3.2-6.87-1.81l-11.88 6.84c-2.4 1.38-3.23 4.44-1.84 6.84l1.03 1.78c-11.91 8.45-22.34 18.88-30.78 30.79l-1.78-1.04c-2.4-1.38-5.43-0.55-6.81 1.85l-6.88 11.87c-1.38 2.4-0.55 5.46 1.84 6.85l1.75 1c-6 13-9.89 27.19-11.25 42.09h-2.03c-2.77 0-5 2.23-5 5v13.72c0 2.77 2.23 5 5 5h2.03c1.37 14.89 5.26 29.07 11.25 42.06l-1.78 1.03c-2.4 1.39-3.16 4.45-1.78 6.85l6.85 11.87c1.38 2.4 4.41 3.2 6.81 1.81l1.78-1.03c8.45 11.93 18.89 22.36 30.81 30.82l-1.03 1.78c-1.38 2.4-0.59 5.42 1.81 6.81l11.88 6.87c2.4 1.39 5.46 0.59 6.84-1.81l1.03-1.78c13 6 27.17 9.89 42.07 11.25v2.06c0 2.77 2.23 5 5 5h13.75c2.77 0 4.96-2.23 4.96-5v-2.06c14.9-1.36 29.07-5.25 42.07-11.25l1.03 1.78c1.38 2.4 4.44 3.2 6.84 1.81l11.91-6.87c2.4-1.39 3.16-4.41 1.78-6.81l-1.03-1.78c11.93-8.46 22.39-18.89 30.84-30.82l1.78 1.03c2.4 1.39 5.43 0.59 6.82-1.81l6.87-11.87c1.39-2.4 0.56-5.46-1.84-6.85l-1.75-1.03c5.99-12.99 9.89-27.17 11.25-42.06h2.03c2.77 0 5-2.23 5-5v-13.72c0-2.77-2.23-5-5-5h-2.03c-1.36-14.89-5.26-29.06-11.25-42.06l1.78-1.03c2.4-1.39 3.16-4.45 1.78-6.85l-6.84-11.87c-1.39-2.4-4.45-3.23-6.85-1.85l-1.78 1.04c-8.45-11.91-18.87-22.34-30.78-30.79l1.03-1.78c1.39-2.4 0.56-5.46-1.84-6.84l-11.85-6.84c-2.4-1.39-5.49-0.59-6.87 1.81l-1 1.75c-13-6-27.17-9.89-42.06-11.25v-2.03c0-2.77-2.27-5-5.04-5h-13.71c-0.18 0-0.34-0.02-0.5 0zm7.37 27.53c59.57 0 107.91 48.34 107.91 107.9 0 59.57-48.34 107.91-107.91 107.91-59.56 0-107.91-48.34-107.91-107.91 0-59.56 48.35-107.9 107.91-107.9z" color="#000000" fill-rule="evenodd"/>
                <path d="m415.33 251.9c0 89.79-72.88 162.66-162.67 162.66s-162.67-72.87-162.67-162.66c4e-3 -89.8 72.88-162.67 162.67-162.67s162.67 72.87 162.67 162.67z" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m252.66 89.23v11.29" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m252.66 402.17v11.29" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m294.62 94.754-2.92 10.906" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m213.62 397.03-2.92 10.91" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m333.72 110.95-5.65 9.78" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m177.25 381.96-5.65 9.78" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m367.29 136.71-7.98 7.99" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m146.01 357.99-7.98 7.99" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m393.06 170.29-9.78 5.64" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m122.04 326.76-9.77 5.64" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m409.25 209.39-10.9 2.92" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m106.98 290.38-10.91 2.92" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m414.78 251.35h-11.3" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m101.84 251.35h-11.294" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m409.25 293.3-10.9-2.92" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m106.98 212.31-10.91-2.92" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m393.06 332.4-9.78-5.64" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m122.04 175.93-9.77-5.64" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m367.29 365.98-7.98-7.99" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m146.01 144.7-7.98-7.99" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m333.72 391.74-5.65-9.78" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m177.25 120.73-5.65-9.78" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m294.62 407.94-2.92-10.91" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m213.62 105.66-2.92-10.906" fill="none" stroke="#000" stroke-width="1px"/>
                <path d="m246.21 124.59h4.1458l5.2351 10.678v-10.678h3.5213v15.569h-4.1466l-5.2367-10.678v10.678h-3.5189z" fill="#f00" stroke-width=".85564"/>
                <path d="m257.39 364.03v3.2952c-0.78983-0.38264-1.5632-0.67095-2.3119-0.86583-0.75692-0.19399-1.4645-0.29187-2.1309-0.29187-0.88938 0-1.5451 0.13258-1.9688 0.39687-0.42453 0.2634-0.6368 0.67363-0.6368 1.2298 0 0.41734 0.14316 0.74214 0.42947 0.97529 0.28632 0.23314 0.80464 0.43247 1.5574 0.59976l1.5813 0.34438c1.5961 0.34704 2.7397 0.87562 3.4144 1.5848 0.67464 0.70922 1.012 1.7174 1.012 3.0237 0 1.7174-0.46896 2.9953-1.4151 3.8326-0.93792 0.83736-2.3777 1.2565-4.3136 1.2565-0.91242 0-1.8281-0.0934-2.7471-0.28119-0.91982-0.18776-1.8388-0.46629-2.7578-0.83469v-3.3886c0.919 0.52769 1.8076 0.92634 2.6657 1.1933 0.85812 0.26785 1.6858 0.40222 2.483 0.40222 0.81122 0 1.4283-0.14683 1.8643-0.4387 0.42783-0.29188 0.64174-0.70922 0.64174-1.2511 0-0.48676-0.14809-0.86228-0.43605-1.1266-0.29619-0.2634-0.88034-0.5001-1.7524-0.70833l-1.4365-0.34437c-1.4398-0.3337-2.4921-0.86584-3.1577-1.5955-0.66477-0.72969-0.99716-1.7139-0.99716-2.9508 0-1.551 0.46238-2.7426 1.388-3.5772 0.92558-0.8338 2.256-1.2512 3.9919-1.2512 0.78736 0 1.6019 0.0641 2.4411 0.1931 0.83096 0.12814 1.6948 0.32124 2.5916 0.57841z" fill="#ccc" stroke-width=".85564"/>
                <path d="m366.15 244.12h10.022v3.0344h-6.3096v2.8992h5.9311v3.0344h-5.9311v3.5666h6.5153v3.0344h-10.227z" fill="#ccc" stroke-width=".85564"/>
                <path d="m122.54 244.12h3.5575l2.488 11.315 2.4682-11.315h3.5789l2.4682 11.315 2.4847-11.315h3.5296l-3.3979 15.569h-4.2782l-2.6114-11.836-2.5842 11.836h-4.2807z" fill="#ccc" stroke-width=".85564"/>
                <path d="m329.25 175.1 12.17-12.17" fill="none" stroke="#fff" stroke-width="1px"/>
                <path d="m329.96 327.99 12.17 12.17" fill="none" stroke="#fff" stroke-width="1px"/>
                <path d="m177.07 328.7-12.17 12.16" fill="none" stroke="#fff" stroke-width="1px"/>
                <path d="m176.36 175.8-12.17-12.16" fill="none" stroke="#fff" stroke-width="1px"/>
                <path transform="matrix(1.154,0,0,1.1498,-105.91,-110.64)" d="m310.72 129.88c-102.31 0-185.43 83.115-185.43 185.43 0 102.31 83.115 185.43 185.43 185.43 102.31 0 185.43-83.115 185.43-185.43 0-102.31-83.115-185.43-185.43-185.43z" fill="none" stroke="url(#d)" stroke-width="4.3407"/>
                <path d="m265.19 55.147c-3.03-0.275-4.95 4.318-5.28 5.062-3.2-8.136-16.95-5.948-17.5 2.813-1.01 6.676-1.43 17.239 6.69 19.562 6.13 1.857 12.09-3.136 12.03-9.375 0.63-1.951-0.25-7.027 0.44-7.187 3.75 5.053 11.44-0.201 9.75-5.719-0.42-2.899-3.07-5.525-6.13-5.156zm-13.56 8.5c0.75 3.349 0.76 7.262 0 10.531-0.7-3.304-0.81-7.404 0-10.531zm-194.25 174.43c-6.125-0.47-9.593 5.63-9.438 11.07 3.296 0.67 11.166-0.32 5.75 3.22-3.813 3.26-6.01 7.99-6.156 13h20.625c0.965-5.54-0.072-10.85-4.938-9.57 2.34-1.96 4.444-4.75 4.782-7.97 3.666-0.07 8.568-1.09 4.95 3.25-2.099 4.46-2.716 9.42-3.325 14.29 4.495-0.23 11.138 1.85 9.968-4.6 0.568-4.8 2.485-10.3 5.532-13.59-0.96 6.61-0.543 17.03 7.75 18.44 6.066 1.48 11.69-3.45 11.72-9.5 0.49-2.3 0.01-6.62 0.28-7.5 3.52 5.33 11.82 0.65 10.31-5.16-0.27-5.81-9.07-7.49-11.03-1.78-0.59 4.39-2.27-2.85-5.187-2.88-4.319-1.72-10.152-0.59-12.437 3.75 1.536-7.56-9.324-2.74-14-4.09-5.676-3.1-5.094 4.9-7.125 1.91-2.052-2.08-5.251-2.4-8.031-2.29zm351.37 0c-8.82 0.07-11.39 12.95-5.12 17.97-4.7-0.87-3.16 3.04-1.81 5.63 3.76 6.76 15.36 4.7 17-2.78 1.44 8.56 15.31 9.34 17.56 0.9 1.15-3.57 1.22-7.8 0.91-11.28 3.23 5.31 11.34 1.02 10.15-4.62 0.18-5.6-8.11-8.18-10.53-2.78-0.76 1.48-0.61 3.31-1.59 0.81-3.74-6.37-15.17-4.6-16.53 2.84-1.3-4.45-5.42-7.19-10.04-6.69zm0.88 7.97c1.58 0.79-0.02 5.95-0.44 2.25 0.05-0.71-0.13-1.73 0.44-2.25zm-314.81 0.35c0.807 3.01 1.065 8.39-0.094 10.62-0.701-3.3-0.82-7.4 0.094-10.62zm-36.594 0.03c1.292 0.93-1.644 3.61-0.375 0.69 0.096-0.24 0.132-0.61 0.375-0.69zm369.5 0.22c0.7 3.04 0.85 7.92-0.09 10.25-0.55-3.22-0.73-7.34 0.09-10.25zm-142.97 176.15c-3.38-0.38-5.44 4.82-5.65 5.72-2.89-8.42-17.15-7.22-18.85 1.06-1.67-10.02-20.27-8.79-19.5 1.91-0.06 2.44 2.56 4.11 0.16 6.03-3.03 6.01 2.11 13.73 8.91 12.94 4.5 0.89 9.7-2.26 10.84-5.91 3.08 9.02 18.63 7.43 19.22-2.37 0.88-2.65 0.24-8.15 0.44-9.28 3.14 5.64 12.21 1.86 11.03-4.28-0.17-3.31-3.22-6.23-6.6-5.82zm-55.46 1.1c-0.92 3.82-5.94 4.25-7.35 6.65-0.11 4.57-1.19 10.67 4.6 6.75 4.08-0.67-0.81 11.23 2.46 12.78 8.44 2.16 10.16-2.38 8.82-10-0.68-5.41 1.35-13.54-1-17.28-2.09 0.67-6.69-1.36-7.53 1.1zm21.18 6.78c1.63 1.34-1.33 1.79 0 0zm19.38 0.37c1.11 2.9 1.37 8.57-0.03 10.94-0.99-3.34-1.06-7.69 0.03-10.94zm-10.38 3.72c0.07 3.35-1.08-0.2 0 0zm-9.03 4.91c2.93 2.21-2.15 4.99 0 0z" fill="#fff" filter="url(#g)"/>
                <path d="m243.9 68.895c0-4.355 0.65-7.401 1.95-9.141 1.29-1.74 3.26-2.609 5.92-2.609 1.27 0 2.32 0.19 3.13 0.57 0.82 0.38 1.49 0.875 2.01 1.484 0.51 0.61 0.92 1.25 1.22 1.922 0.29 0.672 0.53 1.456 0.71 2.352 0.36 1.708 0.53 3.489 0.53 5.343 0 4.157-0.58 7.198-1.74 9.125-1.16 1.928-3.16 2.891-6.01 2.891-1.59 0-2.88-0.307-3.86-0.922-0.98-0.614-1.78-1.515-2.41-2.703-0.46-0.844-0.81-1.997-1.07-3.461-0.25-1.463-0.38-3.081-0.38-4.851zm5.22 0.015c0 2.917 0.21 4.909 0.64 5.977 0.42 1.067 1.04 1.601 1.85 1.601 0.54 0 1-0.226 1.39-0.679s0.68-1.17 0.87-2.149c0.18-0.979 0.27-2.505 0.27-4.578 0-3.042-0.21-5.086-0.64-6.133-0.42-1.047-1.06-1.57-1.91-1.57-0.87 0-1.5 0.534-1.89 1.602-0.39 1.067-0.58 3.044-0.58 5.929zm20.3-7.312c0 1.229-0.36 2.281-1.08 3.156-0.73 0.875-1.6 1.312-2.63 1.312-1.01 0-1.88-0.437-2.61-1.312-0.72-0.875-1.08-1.927-1.08-3.156 0-1.24 0.36-2.295 1.08-3.164 0.73-0.87 1.6-1.305 2.61-1.305 1.03 0 1.9 0.435 2.63 1.305 0.72 0.869 1.08 1.924 1.08 3.164zm-2.4-0.016c0-0.437-0.13-0.812-0.38-1.125-0.26-0.312-0.56-0.469-0.93-0.469-0.36 0-0.67 0.157-0.93 0.469-0.25 0.313-0.38 0.688-0.38 1.125 0 0.438 0.13 0.81 0.38 1.117 0.26 0.308 0.57 0.461 0.93 0.461 0.37 0 0.67-0.153 0.93-0.461 0.25-0.307 0.38-0.679 0.38-1.117zm-31.2 363.21v23.29h-5.83v-15.26c-0.94 0.79-1.85 1.43-2.73 1.92-0.89 0.49-1.99 0.96-3.32 1.41v-5.22c1.96-0.7 3.48-1.54 4.57-2.52 1.08-0.98 1.93-2.19 2.54-3.62zm9.75 10.98c-0.9-0.53-1.56-1.12-1.98-1.78-0.56-0.9-0.85-1.93-0.85-3.09 0-1.92 0.82-3.49 2.45-4.71 1.27-0.93 2.95-1.4 5.05-1.4 2.77 0 4.81 0.58 6.14 1.75 1.32 1.16 1.98 2.63 1.98 4.4 0 1.03-0.26 2-0.79 2.89-0.39 0.67-1.02 1.32-1.86 1.94 1.12 0.6 1.95 1.38 2.51 2.36 0.55 0.98 0.82 2.06 0.82 3.25 0 1.15-0.23 2.22-0.71 3.21-0.48 1-1.06 1.77-1.75 2.31-0.7 0.54-1.56 0.94-2.59 1.19-1.03 0.26-2.13 0.38-3.3 0.38-2.2 0-3.88-0.28-5.03-0.85-1.16-0.58-2.05-1.42-2.65-2.54-0.6-1.11-0.9-2.36-0.9-3.73 0-1.34 0.28-2.48 0.85-3.41 0.56-0.94 1.43-1.66 2.61-2.17zm2.59-4.5c0 0.79 0.22 1.43 0.67 1.92 0.45 0.48 1.04 0.72 1.79 0.72 0.66 0 1.2-0.24 1.62-0.72 0.43-0.48 0.64-1.1 0.64-1.86 0-0.79-0.22-1.43-0.67-1.93-0.44-0.49-1-0.74-1.69-0.74-0.7 0-1.27 0.24-1.71 0.73-0.43 0.48-0.65 1.11-0.65 1.88zm-0.31 9.86c0 1.01 0.27 1.84 0.83 2.48s1.19 0.96 1.91 0.96c0.69 0 1.3-0.33 1.85-0.98s0.82-1.47 0.82-2.47c0-1.01-0.27-1.84-0.83-2.49-0.55-0.64-1.19-0.97-1.91-0.97s-1.34 0.31-1.87 0.94c-0.54 0.62-0.8 1.47-0.8 2.53zm13.6-4.59c0-4.36 0.71-7.4 2.12-9.14 1.42-1.74 3.58-2.61 6.49-2.61 1.39 0 2.54 0.19 3.43 0.57 0.9 0.38 1.63 0.87 2.19 1.48 0.57 0.61 1.01 1.25 1.34 1.92 0.32 0.68 0.58 1.46 0.78 2.36 0.39 1.7 0.58 3.49 0.58 5.34 0 4.16-0.63 7.2-1.91 9.12-1.27 1.93-3.46 2.89-6.57 2.89-1.74 0-3.15-0.3-4.23-0.92-1.07-0.61-1.95-1.51-2.64-2.7-0.5-0.84-0.89-2-1.17-3.46-0.27-1.46-0.41-3.08-0.41-4.85zm5.71 0.01c0 2.92 0.23 4.91 0.7 5.98 0.46 1.07 1.14 1.6 2.03 1.6 0.58 0 1.09-0.23 1.52-0.68 0.42-0.45 0.74-1.17 0.94-2.15 0.21-0.98 0.31-2.5 0.31-4.58 0-3.04-0.24-5.08-0.7-6.13-0.47-1.04-1.17-1.57-2.1-1.57-0.95 0-1.64 0.54-2.07 1.6-0.42 1.07-0.63 3.05-0.63 5.93zm22.22-7.31c0 1.23-0.39 2.28-1.19 3.16-0.79 0.87-1.74 1.31-2.87 1.31-1.11 0-2.06-0.44-2.85-1.31-0.79-0.88-1.19-1.93-1.19-3.16 0-1.24 0.4-2.29 1.19-3.16s1.74-1.31 2.85-1.31c1.13 0 2.08 0.44 2.87 1.31 0.8 0.87 1.19 1.92 1.19 3.16zm-2.63-0.02c0-0.43-0.14-0.81-0.42-1.12-0.27-0.31-0.61-0.47-1.01-0.47-0.39 0-0.73 0.16-1.01 0.47-0.29 0.31-0.43 0.69-0.43 1.12 0 0.44 0.14 0.81 0.43 1.12 0.28 0.31 0.62 0.46 1.01 0.46 0.4 0 0.74-0.15 1.01-0.46 0.28-0.31 0.42-0.68 0.42-1.12zm115.85-171 5.22-0.8c0.14 0.89 0.37 1.51 0.69 1.88 0.33 0.36 0.73 0.54 1.2 0.54 0.85 0 1.5-0.51 1.98-1.54 0.34-0.77 0.6-2.37 0.77-4.83-0.63 0.78-1.27 1.35-1.93 1.72-0.67 0.36-1.43 0.54-2.3 0.54-1.69 0-3.12-0.73-4.28-2.18-1.17-1.46-1.75-3.31-1.75-5.54 0-1.52 0.3-2.9 0.89-4.15s1.41-2.2 2.45-2.84 2.34-0.96 3.92-0.96c1.89 0 3.4 0.39 4.55 1.18 1.14 0.79 2.05 2.04 2.73 3.75 0.69 1.71 1.03 3.98 1.03 6.79 0 4.13-0.72 7.16-2.15 9.09-1.44 1.92-3.43 2.88-5.97 2.88-1.51 0-2.69-0.21-3.56-0.63-0.87-0.43-1.59-1.04-2.16-1.86-0.58-0.81-1.02-1.82-1.33-3.04zm9.67-10.22c0-1.24-0.26-2.21-0.78-2.92-0.51-0.7-1.14-1.05-1.88-1.05-0.7 0-1.27 0.32-1.73 0.95-0.46 0.64-0.69 1.59-0.69 2.86 0 1.28 0.24 2.26 0.71 2.94 0.48 0.68 1.07 1.02 1.79 1.02 0.74 0 1.35-0.33 1.84-0.99s0.74-1.59 0.74-2.81zm7.73 3.81c0-4.35 0.65-7.4 1.94-9.14s3.26-2.61 5.91-2.61c1.27 0 2.31 0.19 3.13 0.57s1.48 0.88 2 1.49c0.51 0.6 0.92 1.25 1.22 1.92 0.29 0.67 0.53 1.45 0.71 2.35 0.35 1.71 0.53 3.49 0.53 5.34 0 4.16-0.58 7.2-1.74 9.13-1.16 1.92-3.16 2.89-5.99 2.89-1.59 0-2.88-0.31-3.86-0.92-0.98-0.62-1.78-1.52-2.41-2.71-0.45-0.84-0.81-1.99-1.06-3.46-0.25-1.46-0.38-3.08-0.38-4.85zm5.21 0.02c0 2.91 0.21 4.91 0.63 5.97 0.43 1.07 1.05 1.6 1.85 1.6 0.54 0 1-0.22 1.39-0.68 0.39-0.45 0.68-1.16 0.86-2.14 0.19-0.98 0.28-2.51 0.28-4.58 0-3.04-0.21-5.09-0.64-6.13-0.42-1.05-1.06-1.57-1.91-1.57-0.87 0-1.5 0.53-1.88 1.6-0.39 1.06-0.58 3.04-0.58 5.93zm20.26-7.32c0 1.23-0.36 2.29-1.08 3.16-0.73 0.88-1.6 1.31-2.62 1.31s-1.88-0.43-2.6-1.31c-0.73-0.87-1.09-1.93-1.09-3.16 0-1.24 0.36-2.29 1.09-3.16 0.72-0.87 1.58-1.3 2.6-1.3s1.89 0.43 2.62 1.3c0.72 0.87 1.08 1.92 1.08 3.16zm-2.4-0.01c0-0.44-0.13-0.81-0.38-1.13-0.25-0.31-0.56-0.47-0.92-0.47s-0.67 0.16-0.93 0.47c-0.26 0.32-0.39 0.69-0.39 1.13s0.13 0.81 0.39 1.12c0.26 0.3 0.57 0.46 0.93 0.46s0.67-0.16 0.92-0.46c0.25-0.31 0.38-0.68 0.38-1.12zm-376.9 18.86h-16.342c0.187-1.89 0.755-3.66 1.705-5.32 0.949-1.66 2.73-3.63 5.343-5.89 1.596-1.38 2.616-2.43 3.062-3.15s0.669-1.4 0.669-2.05c0-0.7-0.221-1.29-0.662-1.79-0.442-0.49-0.997-0.74-1.665-0.74-0.696 0-1.264 0.26-1.705 0.77-0.442 0.51-0.738 1.41-0.89 2.7l-5.456-0.52c0.214-1.79 0.606-3.19 1.177-4.19 0.57-1.01 1.375-1.78 2.414-2.31 1.038-0.54 2.476-0.81 4.313-0.81 1.917 0 3.408 0.26 4.473 0.77 1.066 0.51 1.904 1.29 2.514 2.35 0.611 1.06 0.916 2.24 0.916 3.55 0 1.4-0.349 2.73-1.049 4s-1.973 2.67-3.818 4.19c-1.097 0.89-1.83 1.51-2.2 1.86s-0.805 0.82-1.304 1.39h8.505zm2.448-22.91h15.901v4.3c-1.382 1.46-2.537 3.03-3.464 4.73-1.123 2.07-2.01 4.36-2.661 6.89-0.517 1.97-0.865 4.3-1.043 6.99h-5.43c0.428-3.74 1.101-6.88 2.019-9.41 0.919-2.53 2.372-5.24 4.36-8.12h-9.682zm18.201 11.36c0-4.35 0.671-7.4 2.013-9.14s3.385-2.61 6.132-2.61c1.319 0 2.402 0.19 3.249 0.57s1.538 0.88 2.074 1.49c0.53 0.6 0.96 1.25 1.26 1.92 0.31 0.67 0.56 1.45 0.75 2.35 0.36 1.71 0.54 3.49 0.54 5.34 0 4.16-0.6 7.2-1.8 9.13-1.205 1.92-3.278 2.89-6.221 2.89-1.649 0-2.982-0.31-3.998-0.92-1.017-0.62-1.85-1.52-2.501-2.71-0.473-0.84-0.84-1.99-1.103-3.46-0.263-1.46-0.395-3.08-0.395-4.85zm5.403 0.02c0 2.91 0.221 4.91 0.662 5.97 0.441 1.07 1.081 1.6 1.919 1.6 0.553 0 1.032-0.22 1.438-0.68 0.405-0.45 0.704-1.16 0.896-2.14 0.191-0.98 0.287-2.51 0.287-4.58 0-3.04-0.22-5.09-0.662-6.13-0.441-1.05-1.103-1.57-1.986-1.57-0.9 0-1.551 0.53-1.952 1.6-0.401 1.06-0.602 3.04-0.602 5.93zm21.025-7.32c0 1.23-0.38 2.29-1.13 3.16-0.74 0.88-1.65 1.31-2.71 1.31-1.05 0-1.95-0.43-2.7-1.31-0.75-0.87-1.12-1.93-1.12-3.16 0-1.24 0.37-2.29 1.12-3.16s1.65-1.3 2.7-1.3c1.06 0 1.97 0.43 2.71 1.3 0.75 0.87 1.13 1.92 1.13 3.16zm-2.49-0.01c0-0.44-0.13-0.81-0.39-1.13-0.27-0.31-0.59-0.47-0.96-0.47s-0.7 0.16-0.96 0.47c-0.27 0.32-0.4 0.69-0.4 1.13s0.13 0.81 0.4 1.12c0.26 0.3 0.59 0.46 0.96 0.46s0.69-0.16 0.96-0.46c0.26-0.31 0.39-0.68 0.39-1.12z"/>
                <ellipse transform="matrix(.70951 -.70469 .70951 .7047 0 0)" cx="1.8218" cy="259.75" rx="139.91" ry="76.121" fill="url(#b)" fill-rule="evenodd" opacity=".5" stroke-width="1.4042"/>
                <path d="m61.334 224.35c22.558-135.9 175.55-176.82 161.48-165.31-0.17 43.76 10.2 87.03 17.61 130.87-14.49 10.09-29.26 18.66-39.8 50.51-45.99-5.8-87.86-15.71-139.29-16.07z" fill="url(#f)" fill-rule="evenodd"/>
            </g>
            <path
                    id="compass_needle"
                    style="fill:#000000;fill-rule:evenodd;stroke:#000000;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                    [attr.transform]="transform"
                    d="M 0,90 
      V -90
      c 1.44,16 2.28,53 8.42,68 
      l -8.42,-1 
      v 90 z
      v -180
      c -1.44,16 -2.28,53 -8.42,68 
      l 8.42,-1"
            />

        </svg>
    `,
    styles: [ `` ]
})

export class CompassWidget implements OnInit, OnDestroy {

    @Input() public config: ICompassConfig;

    private realtimeMeasurements$;

    public transform = `translate(227,227) rotate(0)`;

    constructor(
        private measurementService: MeasurementService,
        private realtime: Realtime) {
    }

    ngOnInit() {
        this.updateForDeviceChange();
    }

    ngOnDestroy(): void {
        // Unsubscribe from realtime measurement subscriptions
        if( this.realtimeMeasurements$ !== undefined ) {
            this.realtime.unsubscribe(this.realtimeMeasurements$);
        }
    }

    private async updateForDeviceChange() {
        // Get the measurement configuration details
        const measurement = this.config.measurementSeries.split('.');
        if (measurement.length !== 2) {
            return;
        }
        const measurementFragment = measurement[0];
        const measurementSeries = measurement[1];

        let _dateTo = new Date();
        _dateTo.setDate( _dateTo.getDate() + 1 );
        const dateTo = _dateTo.toISOString();

        const filter = {
            source: this.config.device.id,
            dateFrom: '1970-01-01',
            dateTo,
            valueFragmentType: measurementFragment,
            valueFragmentSeries: measurementSeries,
            pageSize: 1,
            revert: true
        };

        // Get the latest historical measurement for this {measurementFragment.measurementSeries}
        const {data, res, paging} = await this.measurementService.list(filter);

        if (data.length > 0) {
            const measurementObject = data[0];
            const measurementValue = measurementObject[measurementFragment][measurementSeries].value;
            this.moveCompassNeedle(measurementValue);
        }

        // Subscribe to real-time updates
        this.realtimeMeasurements$ = this.realtime.subscribe(`/measurements/${this.config.device.id}`, realtimeData => {
            if (_.has(realtimeData.data.data, `${measurementFragment}.${measurementSeries}`)) {
                const measurementValue = realtimeData.data.data[measurementFragment][measurementSeries].value;
                this.moveCompassNeedle(measurementValue);
            }
        });
    }

    private moveCompassNeedle(heading) {
        this.transform = `translate(227,227) rotate(${heading})`;
    }

}
